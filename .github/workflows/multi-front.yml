# .github/workflows/ci.yml
name: CI Pipeline

on:
  push:
    branches:
      - dev # dev 브랜치에 푸시될 때 실행

env:
  DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME2 }}
  DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD2 }}
  DOCKER_REPOSITORY: ${{ secrets.DOCKER_REPOSITORY }}  # ECR 리포지토리 이름(url)

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Source Code # 깃에 새롭게 푸쉬된 소스코드 검사
        uses: actions/checkout@v3

      - name: Set up Docker Buildx # 도커 빌드 환경 설정
        uses: docker/setup-buildx-action@v2

      - name: Log in to Amazon ECR # ECR 로그인
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: ${{ secrets.AWS_REGION }} # ECR이 위치한 AWS 리전
        run: |
          echo "Logging in to Amazon ECR..."
          aws ecr get-login-password --region $AWS_REGION | docker login --username AWS --password-stdin $DOCKER_REPOSITORY

      - name: Build and Push Docker Image # 빌드된 도커 이미지 ECR에 푸쉬
        run: |
          docker build -t $DOCKER_REPOSITORY:${{ github.run_number }} .
          docker push $DOCKER_REPOSITORY:${{ github.run_number }}

      - name: Set Docker Image Output
        id: docker_image
        run: |
          echo "::set-output name=image::$DOCKER_REPOSITORY:${{ github.run_number }}"
